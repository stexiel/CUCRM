# Документация модуля чата CUCRM

## Обзор

Модуль чата CUCRM предоставляет полноценный WebSocket чат с расширенным функционалом для EspoCRM.

## Архитектура

### Компоненты
- **WebSocket сервер:** `chat-websocket-server.php`
- **Клиент:** JavaScript в `client/custom/src/views/chat/`
- **База данных:** 5 таблиц чата

### Таблицы чата
- `chat` - основные комнаты чата
- `chat_message` - сообщения
- `chat_room` - комнаты
- `chat_room_user` - участники комнат
- `chat_user` - пользователи чата

## Запуск чата

### 1. WebSocket сервер
```bash
php chat-websocket-server.php
```
Сервер запускается на порту 8081

### 2. Доступ к чату
http://localhost:8080/#ChatRoom

## Функционал

### Основные возможности
- **Реальное время:** WebSocket соединение
- **Комнаты:** Создание и управление чат-комнатами
- **Сообщения:** Текст, файлы, реакции
- **Уведомления:** Прочтение, упоминания
- **История:** Сохранение всех сообщений

### Типы комнат
- **Групповые:** Многопользовательские чаты
- **Личные:** Диалоги между пользователями
- **Системные:** Уведомления и объявления

## Миграция данных

### Подготовка базы данных
1. Убедитесь что MySQL работает
2. Проверьте подключение к базе `cucrm`
3. Создайте таблицы чата при необходимости

### Проверка структуры
```bash
php -r "
$pdo = new PDO('mysql:host=localhost;dbname=cucrm', 'cuadmin', 'password');
$stmt = $pdo->query('SHOW TABLES LIKE \"chat%\"');
foreach($stmt->fetchAll() as $table) echo $table[0] . PHP_EOL;
"
```

## Нововведения в модуле чата

### Версия 2.0
- **WebSocket:** Реальное время вместо REST
- **Реакции:** Эмодзи к сообщениям
- **Файлы:** Загрузка и скачивание
- **Поиск:** Поиск по сообщениям
- **Уведомления:** Push уведомления

### Улучшения
- **Производительность:** Оптимизированные запросы
- **Безопасность:** Валидация данных
- **Интерфейс:** Современный дизайн
- **Мобильность:** Адаптивный интерфейс

## Конфигурация

### WebSocket сервер
```php
// chat-websocket-server.php
$host = '0.0.0.0';
$port = 8081;
```

### База данных
```php
// data/config-internal.php
'database' => [
    'host' => 'localhost',
    'dbname' => 'cucrm',
    'user' => 'cuadmin',
    'password' => 'Q0Cek@fpos_uLs59'
]
```

## Траблшутинг

### Проблема: Чат не подключается
1. Проверьте что WebSocket сервер запущен
2. Проверьте порт 8081 доступен
3. Проверьте подключение к базе данных

### Проблема: Сообщения не отправляются
1. Проверьте права доступа к таблицам чата
2. Проверьте WebSocket соединение
3. Проверьте логи сервера

## Разработка

### Добавление нового функционала
1. Модифицируйте `chat-websocket-server.php`
2. Обновите клиентский JavaScript
3. Добавьте таблицы в базу при необходимости

### Кастомизация
- **Интерфейс:** `client/custom/src/views/chat/`
- **Логика:** `chat-websocket-server.php`
- **База:** Добавьте таблицы в MySQL

## Поддержка

Для технической поддержки обращайтесь к разработчикам CUCRM.
